
- name: infra-ec2-wait_for_linux_hosts
  hosts:
    - all:!windows
  become: true
  gather_facts: no
  roles:
  - { role: "infra-ec2-wait_for_linux_hosts" }

###############     Play for solutions  ###############
- import_playbook: ./solve_section1.yml
  when: solve == "true"

###############     Play1 for grade     ###############
- name: Verify Section1
  hosts: all:!bastions
  gather_facts: no
  tasks:

#****************************#
########## Grade 1 ########### 
#****************************#
  - name: Verify devops user is created
    shell: "grep devops /etc/passwd | cut -d: -f1"
    register: user_created

  - name: Verify /etc/motd has content
    shell: "cat /etc/motd"
    register: motd

#### condiation1 Fail ####
  - name: set grade to fail
    set_fact:
      result: "{{ result + [ inventory_hostname + ' : FAIL' ] }}" 
      reason: "{{ reason + [ inventory_hostname + ' : devops user does not exist.' ] }}"
    when: user_created.stdout != "devops"

  - name: set grade to fail
    set_fact:
      result: "{{ result + [ inventory_hostname + ' : FAIL' ] }}" 
      reason: "{{ reason + [ inventory_hostname + ' : /etc/motd missing content' ] }}"
    when: motd.stdout != "Managed by Ansible"

#### condiation1 Psss ####
  - name: set grade to Pass
    set_fact:
      result: "{{ result + [ inventory_hostname + ' : PASS' ] }}" 
      reason: "{{ reason + [ inventory_hostname + ' : devops user exists.' ] }}"
    when: user_created.stdout == "devops"

  - name: set grade to Pass
    set_fact:
      result: "{{ result + [ inventory_hostname + ' : PASS' ] }}" 
      reason: "{{ reason + [ inventory_hostname + ' : /etc/motd missing content' ] }}"
    when: motd.stdout == "Managed by Ansible"
  
# - debug: var=reason
# - debug: var=result
#******************* Concatenate list, Must be included at the end of each play in playbook ***********************#
  - name: Include concatenate assessment_result role in play1
    include_role: 
      name: assessment_result
 # - debug: var=assessment_result
#************************        End of Concatenate list, Must be included         ********************************#


############## Play for Adding variable back to localhost ##############################
- name: append grade list from section1
  hosts: localhost
  tasks:
  - name: setting up section1 array
    set_fact:
      array:
        section1:
          result: 
              - "{{ hostvars['app1']['result'] }}"
              - "{{ hostvars['app2']['result'] }}"
          reason:
              - "{{ hostvars['app1']['reason'] }}"
              - "{{ hostvars['app2']['reason'] }}"
          assessment_result:
              - "{{ hostvars['app1']['assessment_result'] }}"
              - "{{ hostvars['app2']['assessment_result'] }}"

  -  set_fact:   
      grade_status: "{{ grade_status | combine(array) }}"
  

